# 知夏笔记 - 优化计划

> 生成时间：2025-01-20
> 审查范围：功能完整性、代码质量、性能优化、用户体验

---

## 📊 审查摘要

### ✅ 功能状态
- **核心功能**：文件操作、Git同步、Markdown编辑器 - **正常**
- **未完成功能**：文件拖拽移动、加密UI入口、导出功能 - **待实现**

### 🐗 发现的问题
- **高优先级**：7 个
- **中优先级**：5 个
- **低优先级**：3 个

---

## 🎯 优化任务清单

### 第一阶段：修复关键问题 (优先级：🔴 高)

#### 1. 完善文件重命名逻辑
**问题**：重命名后编辑器清空，未保持选中状态
**位置**：`src/store/FileStore.ts:216-231`
**方案**：重命名后查找新路径并重新选中文件

#### 2. 移除/实现 moveItem 方法
**问题**：`moveItem` 只有占位代码和警告
**位置**：`src/store/FileStore.ts:233-250`
**方案**：实现完整的文件/文件夹移动功能

#### 3. 统一错误处理机制
**问题**：混用 `alert()`、Toast 和 `console.error`
**位置**：多处
**方案**：全部使用 Toast 统一处理

#### 4. 添加应用关闭前未保存警告
**问题**：关闭应用时未提示未保存的更改
**方案**：监听 `beforeunload` 事件

#### 5. 修复自动保存 UI 阻塞问题
**问题**：切换文件时自动保存会显示全屏加载
**位置**：`src/store/FileStore.ts:93-112`
**方案**：改为后台保存 + Toast 提示

---

### 第二阶段：性能优化 (优先级：🟡 中)

#### 6. 优化文件树更新机制
**问题**：每次操作都重新加载整个目录树
**位置**：`src/store/FileStore.ts:177-231`
**方案**：实现增量更新

#### 7. 优化 Git 状态轮询
**问题**：每 10 秒轮询，消耗资源
**位置**：`src/store/GitStore.ts:29-34`
**方案**：改为事件驱动 + 增加轮询间隔到 30 秒

#### 8. 添加代码分割
**问题**：所有组件都在主包中
**方案**：使用 React.lazy() 懒加载

#### 9. 清理生产环境日志
**问题**：8 个文件中有 `console.log`
**方案**：移除或使用条件日志

---

### 第三阶段：用户体验提升 (优先级：🟢 中)

#### 10. 添加快捷键帮助面板
**方案**：按下 `Cmd+/` 显示快捷键列表

#### 11. 增强搜索功能
**问题**：只能搜索文件名
**方案**：添加内容搜索 + 模糊匹配 + `Cmd+P` 快速打开

#### 12. 优化删除确认对话框
**问题**：使用原生 `confirm()`
**方案**：自定义对话框，支持样式统一

#### 13. 添加 Git 冲突解决界面
**问题**：检测到冲突但没有 UI
**方案**：添加冲突解决编辑器

#### 14. 添加加密功能 UI 入口
**问题**：加密服务已实现但无入口
**方案**：在 Toolbar 和右键菜单添加加密选项

---

### 第四阶段：代码质量改进 (优先级：🟢 低)

#### 15. 清理注释代码
**位置**：多处
**方案**：删除无用的注释代码

#### 16. 提取重复逻辑
**问题**：防抖自动保存逻辑重复
**位置**：`src/components/Editor/index.tsx:43-50, 80-86`
**方案**：提取为自定义 hook `useAutoSave`

#### 17. 改进类型定义
**问题**：每次加载文件树都会重新生成 UUID
**位置**：`src/store/FileStore.ts:42`
**方案**：基于路径生成稳定的 ID

---

## 📝 实施记录

### 已完成任务 ✅

- [x] **任务 1: 完善文件重命名逻辑** - 重命名后自动重新选择文件，保持编辑器状态
- [x] **任务 2: 实现 moveItem 方法** - 完整实现文件/文件夹拖拽移动功能
- [x] **任务 3: 统一错误处理** - 所有错误统一使用 Toast 提示，移除 alert
- [x] **任务 4: 添加未保存警告** - 应用关闭前检查未保存的文件并提示
- [x] **任务 5: 修复自动保存 UI** - 改为后台保存，不再阻塞用户界面
- [x] **任务 6: 优化文件树更新** - 实现增量更新，避免全量重载
- [x] **任务 7: 优化 Git 轮询** - 轮询间隔从 10s 增加到 30s，添加事件驱动更新
- [x] **任务 8: 代码分割** - 对 Welcome 和 MarkdownHelp 组件使用 React.lazy()
- [x] **任务 9: 清理日志** - 移除生产环境的 console.log
- [x] **任务 10: 快捷键帮助** - 添加快捷键帮助面板，按 Cmd+/ 显示
- [x] **任务 11: 增强搜索** - 添加模糊匹配支持

### 待完成任务 📋

- [ ] 任务 12: 优化删除确认（自定义对话框）
- [ ] 任务 13: Git 冲突解决界面
- [ ] 任务 14: 加密功能 UI 入口
- [ ] 任务 15: 清理注释代码
- [ ] 任务 16: 提取重复逻辑为自定义 hooks
- [ ] 任务 17: 改进类型定义（稳定的文件 ID）

---

## 🔧 技术债务追踪

### 已知限制
1. 文件拖拽移动未实现
2. 加密功能无 UI 入口
3. 导出功能未验证
4. 大文件（>1000 行）编辑可能卡顿

### 安全性考虑
- ✅ 路径验证已实现 (`fileService.ts:214-219`)
- ✅ 加密服务使用 AES-256-GCM
- ⚠️ Git Token 存储在配置文件中（建议使用系统钥匙串）

### 兼容性
- 当前仅支持 macOS
- Windows 和 Linux 支持待验证

---

生成者：Claude Code (Sonnet 4.5)
